<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Workout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <style>
    :root{
      --male-bg:#e9f2ff; --male-border:#6aa6ff; --male-accent:#2c6cff;
      --female-bg:#ffe9f4; --female-border:#ff86b7; --female-accent:#e33682;
      --ok:#16a34a; --muted:#666;
    }
    html,body{height:100%}
    body{
      font-family:Arial,Helvetica,sans-serif;
      padding:24px;
      background:#fafafa;
      color:#111;
      -webkit-text-size-adjust:100%;
    }
    h1{margin:0 0 6px;font-size:2rem;}
    .muted{color:var(--muted);font-size:1rem;margin:4px 0 16px}
    .counter-title{
      margin-top:4px;
      font-size:1.3rem;
      font-weight:700;
      color:#444;
    }
    .overall-box{
      margin:8px 0 18px;
      padding:12px;
      background:#fff;
      border-radius:10px;
      border:1px solid #ddd;
      font-size:0.95rem;
    }
    .overall-person-block{
      padding:6px 0 10px;
      border-bottom:1px solid #eee;
    }
    .overall-person-block:last-child{
      border-bottom:none;
    }
    .overall-person{
      margin-top:0;
      margin-bottom:4px;
      font-weight:700;
    }
    .overall-row{
      display:flex;
      justify-content:space-between;
      padding:2px 0;
    }
    .text-small{
      font-size:0.85rem;
      color:#666;
      margin-top:4px;
    }
    .date-line{
      font-size:1.8rem;
      font-weight:700;
      margin:4px 0 8px;
    }
    .container{display:flex;gap:20px;flex-wrap:wrap}
    .panel{
      border:2px solid #ddd;
      border-radius:12px;
      padding:18px;
      width:340px;
      background:white;
    }
    .panel.male{background:var(--male-bg);border-color:var(--male-border)}
    .panel.female{background:var(--female-bg);border-color:var(--female-border)}
    .panel h2{margin:0 0 10px;font-size:1.4rem}

    .exercise{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin:10px 0;
      padding:10px;
      border-radius:10px;
      background:white;
      cursor:pointer;
      user-select:none;
      border:1px solid #ddd;
    }
    .exercise.done{
      background:#f0fff0;
      border-color:#88cc88;
      color:#1a7f1a;
      font-weight:bold;
    }
    .exercise.injured{
      background:#fff5f5;
      border-color:#f97373;
      color:#b91c1c;
      font-weight:bold;
    }
    .exercise.injured strong{
      color:#b91c1c;
    }

    .skip-btn,
    .injured-btn,
    .cant-btn{
      padding:10px;
      border-radius:8px;
      margin:8px 0;
      cursor:pointer;
      font-size:0.95rem;
    }
    .skip-btn{
      border:1px dashed #bbb;
      background:#fff7f0;
    }
    .injured-btn{
      border:1px dashed #f97373;
      background:#fff0f0;
    }
    .cant-btn{
      border:1px solid #444;
      background:#ffecec;
      font-weight:bold;
    }

    .readonly{
      opacity:.6;pointer-events:none;
    }
    .hidden{display:none;}

    .status{margin:12px 0 16px;font-size:1.1rem;font-weight:600}
    .status .done{color:var(--ok)}
    .status .wait{color:#b45309}

    button{
      padding:12px 16px;
      border-radius:12px;
      border:1px solid #ccc;
      background:#fff;
      cursor:pointer;
      font-size:1rem;
      min-height:48px;
    }
    .disabled{opacity:.5;pointer-events:none}

    @media(max-width:768px){
      body{padding:18px;font-size:18px;line-height:1.35}
      h1{font-size:2rem}
      .date-line{font-size:2rem}
      .container{flex-direction:column;gap:16px}
      .panel{width:100%;max-width:none}
    }
  </style>
</head>
<body>
  <h1>Workout</h1>

  <div class="counter-title">Workout-Counter</div>
  <div id="overallBox" class="overall-box"></div>

  <div class="date-line">Heute: <span id="date">–</span></div>
  <div class="muted">Tag: <span id="day">1</span></div>
  <div id="overallStatus" class="status"></div>

  <div class="container">
    <div class="panel male" id="malePanel">
      <h2>Mann</h2>
      <div id="maleExercises"></div>
    </div>

    <div class="panel female" id="femalePanel">
      <h2>Frau</h2>
      <div id="femaleExercises"></div>
    </div>
  </div>

  <div style="margin-top:18px">
    <button id="nextDayBtn" class="disabled">Nächster Tag</button>
  </div>

  <script>
    const START_DATE = new Date('2025-11-12T00:00:00');
    const params = new URLSearchParams(window.location.search);
    const view = (params.get('view') || '').toLowerCase();
    const whoAmI = view === 'mann' ? 'male' : view === 'frau' ? 'female' : '';

    async function fetchState() {
      const res = await fetch("/api/state");
      return res.json();
    }

    const weekdays = ["So","Mo","Di","Mi","Do","Fr","Sa"];

    function formatDate(day){
      const d = new Date(START_DATE.getTime());
      d.setDate(d.getDate() + (day - 1));
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      return `${weekdays[d.getDay()]}, ${dd}.${mm}.${yyyy}`;
    }

    function getTodayIndex(){
      const today = new Date();
      const t0 = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const s0 = new Date(START_DATE.getFullYear(), START_DATE.getMonth(), START_DATE.getDate());
      const diffDays = Math.floor((t0 - s0) / 86400000);
      return diffDays + 1;
    }

    // ===== Sprüche =====

    const nobody = [/* ... wie vorher, alle Einträge ... */];
    const maleDone = [/* ... wie vorher ... */];
    const femaleDone = [/* ... wie vorher ... */];
    const praiseMale = [/* ... wie vorher ... */];
    const praiseFemale = [/* ... wie vorher ... */];

    // damit die Datei hier nicht explodiert: bitte die Arrays genau aus der letzten Version übernehmen

    const phraseOffsets = {
      nobody: 0,
      maleDone: 7,
      femaleDone: 13,
      praiseMale: 3,
      praiseFemale: 11
    };

    function pickPhrase(arr, key, day){
      if (!Array.isArray(arr) || arr.length === 0) return "";
      const offset = phraseOffsets[key] || 0;
      const idx = ((day || 1) + offset) % arr.length;
      return arr[idx] || "";
    }

    const phraseCache = {
      day: null,
      nobody: "",
      maleDone: "",
      femaleDone: "",
      praiseMale: "",
      praiseFemale: ""
    };

    function ensurePhraseCache(day){
      if (!day) day = 1;
      if (phraseCache.day === day) return;

      phraseCache.day = day;
      phraseCache.nobody       = pickPhrase(nobody,      "nobody",      day);
      phraseCache.maleDone     = pickPhrase(maleDone,    "maleDone",    day);
      phraseCache.femaleDone   = pickPhrase(femaleDone,  "femaleDone",  day);
      phraseCache.praiseMale   = pickPhrase(praiseMale,  "praiseMale",  day);
      phraseCache.praiseFemale = pickPhrase(praiseFemale,"praiseFemale",day);
    }

    // ===== Anti-Flacker-State =====
    let lastOverallDay   = null;
    let lastStatusDay    = null;
    let lastStatusKey    = null;

    // ===== Rendering =====

    function renderOverall(s){
      const box = document.getElementById("overallBox");
      box.innerHTML = "";

      ensurePhraseCache(s.day);

      ["male","female"].forEach(p=>{
        const pname = p==="male" ? "Mann" : "Frau";
        const block = document.createElement("div");
        block.className = "overall-person-block";

        const header = document.createElement("div");
        header.className = "overall-person";
        header.textContent = pname;
        block.appendChild(header);

        let total = 0;
        ["squats","situps","pushups"].forEach(ex=>{
          const row = document.createElement("div");
          row.className = "overall-row";
          const label = ex==="squats" ? "Squats" : ex==="situps" ? "Situps" : "Push Ups";
          const person = s.overall && s.overall[p] ? s.overall[p] : null;
          const val = person && typeof person[ex] === "number" ? person[ex] : 0;
          total += val;
          row.innerHTML = `<span>${label}</span><span>${val} reps total</span>`;
          block.appendChild(row);
        });

        const praise = document.createElement("div");
        praise.className = "text-small";
        if (total === 0){
          praise.textContent = "Noch keine Reps. Aktuell gewinnt die Bequemlichkeit.";
        } else {
          let raw = p==="male" ? phraseCache.praiseMale : phraseCache.praiseFemale;
          if (!raw) raw = "Stabil durchgezogen. Weiter so.";
          const msg = raw.replace("{{total}}", total);
          praise.textContent = msg;
        }
        block.appendChild(praise);

        box.appendChild(block);
      });
    }

    function renderPerson(containerId, key, s){
      const cont = document.getElementById(containerId);
      cont.innerHTML = "";

      const reps = (s.reps && s.reps[key]) || {squats:0,situps:0,pushups:0};
      const day = s.day;
      const skippedToday = (s.skip && s.skip[key] || []).indexOf(day) !== -1;
      const injuredToday = (s.injured && s.injured[key] || []).indexOf(day) !== -1;
      const cantToday = (s.cant && s.cant[key] || []).indexOf(day) !== -1;
      const canClick = (whoAmI === key);

      ["squats","situps","pushups"].forEach(ex=>{
        const row = document.createElement("div");
        let cls = "exercise";
        if (s[key] && s[key][ex]) cls += " done";
        if (injuredToday) cls += " injured";
        row.className = cls;

        const label = ex==="squats" ? "Squats" : ex==="situps" ? "Situps" : "Push Ups";
        const icon = injuredToday ? "✗ " : "";
        const val = reps[ex] || 0;

        row.innerHTML = `<span>${label}</span><strong>${icon}${val}x</strong>`;

        if (canClick){
          row.addEventListener("click", async ()=>{
            await fetch("/api/toggle",{
              method:"POST",
              headers:{"Content-Type":"application/json"},
              body:JSON.stringify({person:key,exercise:ex})
            });
            loadAndRender();
          });
        }

        cont.appendChild(row);
      });

      if (canClick || skippedToday){
        const skip = document.createElement("div");
        skip.className = "skip-btn" + (canClick ? "" : " readonly");
        skip.textContent = "Skip-Day nutzen";
        if (canClick){
          skip.addEventListener("click", async ()=>{
            const r = await fetch("/api/skip",{
              method:"POST",
              headers:{"Content-Type":"application/json"},
              body:JSON.stringify({person:key})
            });
            const data = await r.json();
            if (data.warning) alert(data.warning);
            loadAndRender();
          });
        }
        cont.appendChild(skip);
      }

      if (canClick || injuredToday){
        const inj = document.createElement("div");
        inj.className = "injured-btn" + (canClick ? "" : " readonly");
        inj.textContent = "Verletzt / krank (heute)";
        if (canClick){
          inj.addEventListener("click", async ()=>{
            await fetch("/api/injured",{
              method:"POST",
              headers:{"Content-Type":"application/json"},
              body:JSON.stringify({person:key})
            });
            loadAndRender();
          });
        }
        cont.appendChild(inj);
      }

      if (canClick || cantToday){
        const cant = document.createElement("div");
        cant.className = "cant-btn" + (canClick ? "" : " readonly");
        cant.textContent = "Ich kann nicht mehr";
        if (canClick){
          cant.addEventListener("click", async ()=>{
            const pw = prompt("Passwort eingeben:");
            if (!pw) return;
            const r = await fetch("/api/reps_reduce",{
              method:"POST",
              headers:{"Content-Type":"application/json"},
              body:JSON.stringify({person:key,password:pw})
            });
            if (!r.ok){
              alert("Falsches Passwort. Nett versucht.");
              return;
            }
            loadAndRender();
          });
        }
        cont.appendChild(cant);
      }
    }

    function updateStatus(s, mDone, fDone){
      const out = document.getElementById("overallStatus");
      const day = s.day || 1;

      ensurePhraseCache(day);

      if (mDone && fDone){
        out.innerHTML = "<span class='done'>Beide fertig. So sieht Disziplin aus.</span>";
      } else if (mDone && !fDone){
        const line = phraseCache.femaleDone || "Mann fertig, Frau im Kreativmodus.";
        out.innerHTML = `<span class='wait'>${line}</span>`;
      } else if (!mDone && fDone){
        const line = phraseCache.maleDone || "Frau fertig, Mann im Energiesparmodus.";
        out.innerHTML = `<span class='wait'>${line}</span>`;
      } else {
        const line = phraseCache.nobody || "Niemand fertig. Aktuell gewinnt die Bequemlichkeit.";
        out.innerHTML = `<span class='wait'>${line}</span>`;
      }
    }

    async function loadAndRender(){
      try{
        const s = await fetchState();
        document.getElementById("day").textContent = s.day;
        document.getElementById("date").textContent = formatDate(s.day);

        ensurePhraseCache(s.day);

        // Overall-Sprüche: nur neu bei Tag-Wechsel
        if (s.day !== lastOverallDay){
          renderOverall(s);
          lastOverallDay = s.day;
        }

        renderPerson("maleExercises","male",s);
        renderPerson("femaleExercises","female",s);

        const mDone = s.male && Object.values(s.male).every(Boolean);
        const fDone = s.female && Object.values(s.female).every(Boolean);
        const btn = document.getElementById("nextDayBtn");

        const todayIndex = getTodayIndex();
        const canAdvanceByDate = s.day < todayIndex;

        if (mDone && fDone && canAdvanceByDate){
          btn.classList.remove("disabled");
        } else {
          btn.classList.add("disabled");
        }

        // Status-Spruch: nur neu, wenn Tag oder Kategorie sich ändert
        const statusKey = mDone && fDone ? "both" : (mDone ? "mDone" : (fDone ? "fDone" : "none"));
        if (s.day !== lastStatusDay || statusKey !== lastStatusKey){
          updateStatus(s, mDone, fDone);
          lastStatusDay = s.day;
          lastStatusKey = statusKey;
        }
      } catch(e){
        console.error("Fehler in loadAndRender:", e);
      }
    }

    document.getElementById("nextDayBtn").addEventListener("click", async ()=>{
      const btn = document.getElementById("nextDayBtn");
      if (btn.classList.contains("disabled")) return;
      await fetch("/api/next_day",{method:"POST"});
      loadAndRender();
    });

    loadAndRender();
    setInterval(loadAndRender,5000);
    document.addEventListener("visibilitychange", ()=>{
      if (!document.hidden) loadAndRender();
    });
  </script>
</body>
</html>
