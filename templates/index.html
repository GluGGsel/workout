<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Workout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <style>
    :root{
      --male-bg:#e9f2ff; --male-border:#6aa6ff; --male-accent:#2c6cff;
      --female-bg:#ffe9f4; --female-border:#ff86b7; --female-accent:#e33682;
      --ok:#16a34a; --muted:#666;
    }
    html,body{height:100%}
    body{
      font-family:Arial,Helvetica,sans-serif;
      padding:24px;
      background:#fafafa;
      color:#111;
      -webkit-text-size-adjust:100%
    }
    h1{margin:0 0 6px}
    .muted{color:var(--muted);font-size:1rem;margin:4px 0 16px}
    .date-line{
      font-size:1.8rem;
      font-weight:700;
      margin:4px 0 8px;
    }
    .container{display:flex;gap:20px;flex-wrap:wrap}
    .panel{
      border:2px solid #ddd;
      border-radius:12px;
      padding:18px;
      width:340px;
      background:white;
      transition:box-shadow .15s ease, border-color .15s ease, background .15s ease;
    }
    .panel.male{background:var(--male-bg);border-color:var(--male-border)}
    .panel.female{background:var(--female-bg);border-color:var(--female-border)}
    .panel h2{margin:0 0 10px;font-size:1.4rem}

    .exercise{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin:12px 0;
      padding:12px 10px;
      border-radius:10px;
      background:white;
      cursor:pointer;
      user-select:none;
      border:1px solid #ddd;
    }
    .exercise.done{
      background:#f0fff0;
      border-color:#88cc88;
      color:#1a7f1a;
      font-weight:bold;
    }

    .skip-btn{
      border:1px dashed #bbb;
      padding:10px;
      border-radius:8px;
      margin:10px 0;
      cursor:pointer;
      font-size:0.95rem;
      background:#fff7f0;
    }

    .cant-btn{
      border:1px solid #444;
      padding:10px;
      border-radius:8px;
      margin:10px 0;
      cursor:pointer;
      font-size:0.95rem;
      background:#fff0f0;
      font-weight:bold;
    }

    .readonly .exercise,
    .readonly .skip-btn,
    .readonly .cant-btn{
      opacity:.5;pointer-events:none;
    }

    .status{margin:12px 0 16px;font-size:1.1rem;font-weight:600}
    .status .done{color:var(--ok)}
    .status .wait{color:#b45309}
    .warning{color:#b91c1c;font-weight:700;margin-top:4px}

    button{
      padding:12px 16px;
      border-radius:12px;
      border:1px solid #ccc;
      background:#fff;
      cursor:pointer;
      font-size:1rem;
      min-height:48px;
    }
    .disabled{opacity:.5;pointer-events:none}

    @media(max-width:768px){
      body{padding:18px;font-size:18px;line-height:1.35}
      h1{font-size:2rem}
      .date-line{font-size:2rem}
      .container{flex-direction:column;gap:16px}
      .panel{width:100%;max-width:none}
    }
  </style>
</head>
<body>
  <h1>Workout</h1>
  <div class="date-line">Heute: <span id="date">‚Äì</span></div>
  <div class="muted">Tag: <span id="day">1</span></div>
  <div id="overallStatus" class="status"></div>

  <div class="container">
    <div class="panel male" id="malePanel">
      <h2>Mann</h2>
      <div id="maleExercises"></div>
    </div>

    <div class="panel female" id="femalePanel">
      <h2>Frau</h2>
      <div id="femaleExercises"></div>
    </div>
  </div>

  <div style="margin-top:18px">
    <button id="nextDayBtn" class="disabled">N√§chster Tag</button>
  </div>

  <script>
    const START_DATE = new Date('2025-11-12T00:00:00');

    const params = new URLSearchParams(window.location.search);
    const view = (params.get('view') || '').toLowerCase();
    const clickableFor = view === 'mann' ? 'male' : view === 'frau' ? 'female' : '';

    async function fetchState(){ 
      return (await fetch("/api/state")).json(); 
    }

    const weekdays = ["So","Mo","Di","Mi","Do","Fr","Sa"];

    function formatDate(day){
      const d = new Date(START_DATE.getTime());
      d.setDate(d.getDate() + (day - 1));
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      return `${weekdays[d.getDay()]}, ${dd}.${mm}.${yyyy}`;
    }

    const nobody = [
      "Niemand fertig. Ein Wunder, dass √ºberhaupt jemand hier ist.",
      "Stimmung: 0% Training, 100% Ausreden.",
      "Alle am Leben. Niemand am Trainieren.",
      "Der Schweinehund hat heute alle im Griff.",
      "Keine H√§kchen, aber viel hei√üe Luft.",
      "Wer nichts tut, macht wenigstens nichts falsch.",
      "Niemand fertig ‚Äì aber immerhin konsequent.",
      "Eine Gruppe voller Champions‚Ä¶ morgen vielleicht.",
      "Heute trainieren? Mutige Idee.",
      "Null Fortschritt. Daf√ºr maximale Schonung.",
      "Ich sehe keine H√§kchen, nur Tr√§ume.",
      "Niemand fertig. Klassiker.",
      "Deadlines? Ja. Muskeleinsatz? Nein.",
      "Niemand fertig. Aber Snacks w√§ren jetzt super.",
      "Noch nichts geschafft. √úberraschung?",
      "Niemand fertig. Die Couch applaudiert.",
      "Training wird √ºbersch√§tzt, oder?",
      "Alle tun ihr Bestes ‚Äì beim Nichtstun.",
      "Man k√∂nnte ja anfangen‚Ä¶ k√∂nnte.",
      "Keiner fertig. Daf√ºr alle entspannt."
    ];

    const maleDone = [
      "Mann fertig, Frau auf spiritueller Trainingsreise.",
      "Mann liefert, Frau liefert Ausreden.",
      "Mann durch, Frau‚Ä¶ irgendwo.",
      "Mann fertig, Frau studiert noch Bewegungsabl√§ufe.",
      "Mann ready, Frau waiting.",
      "Mann erledigt. Frau erledigt‚Ä¶ nix.",
      "Mann done. Frau don‚Äôt.",
      "Mann stark. Frau denkt noch nach.",
      "Mann durch, Frau im Ladebildschirm.",
      "Mann fertig, Frau erst bei 'gleich'.",
      "Mann hart, Frau zart.",
      "Mann trainiert, Frau philosophiert.",
      "Mann fertig, Frau testet die Couch.",
      "Mann schwitzt, Frau sitzt.",
      "Mann hat Bock, Frau hat Kaffee.",
      "Mann ist durch. Frau ist dr√ºber.",
      "Mann finished, Frau finnish‚Äôt sp√§ter.",
      "Mann flei√üig, Frau flei-schig? üòè",
      "Mann top, Frau flop ‚Äì noch.",
      "Mann hat geliefert. Frau hat geliefert‚Ä¶ gar nichts."
    ];

    const femaleDone = [
      "Frau fertig, Mann sucht noch Motivation im K√ºhlschrank.",
      "Frau liefert, Mann verirrt.",
      "Frau durch, Mann durch den Wind.",
      "Frau ready, Mann redet sich raus.",
      "Frau stark, Mann‚Ä¶ naja.",
      "Frau schwitzt, Mann sitzt.",
      "Frau k√§mpft, Mann krampft.",
      "Frau fertig, Mann auf Forschungsreise.",
      "Frau done, Mann down.",
      "Frau liefert, Mann liefert Ausreden.",
      "Frau macht, Mann lacht (peinlich).",
      "Frau top, Mann stopp.",
      "Frau aktiv, Mann passiv.",
      "Frau gewinnt, Mann spinnt.",
      "Frau sportlich, Mann wortlich.",
      "Frau liefert, Mann liefert Chips.",
      "Frau durch, Mann fast durch ‚Äì mit der T√ºte Snacks.",
      "Frau strong, Mann wrong.",
      "Frau arbeitet, Mann wartet.",
      "Frau finished, Mann fidget-spinning."
    ];

    let idxNobody=0, idxMale=0, idxFem=0;

    function rot(arr, idxName){
      const i = window[idxName] % arr.length;
      window[idxName]++;
      return arr[i];
    }

    function renderPerson(parentId, key, s, readOnly){
      const cont = document.getElementById(parentId);
      cont.innerHTML = "";

      const reps = s.reps[key];

      for (const ex of ["squats","situps","pushups"]){
        const row = document.createElement("div");
        row.className = "exercise" + (s[key][ex] ? " done" : "");
        const lbl = ex === "squats" ? "Squats" : ex === "situps" ? "Situps" : "Push Ups";

        row.innerHTML = `
          <span>${lbl}</span>
          <strong>${reps[ex]}x</strong>
        `;

        if (!readOnly){
          row.addEventListener("click", async ()=>{
            await fetch("/api/toggle",{
              method:"POST",
              headers:{"Content-Type":"application/json"},
              body:JSON.stringify({person:key,exercise:ex})
            });
            loadAndRender();
          });
        }

        cont.appendChild(row);
      }

      if (!readOnly){

        const skip = document.createElement("div");
        skip.className="skip-btn";
        skip.textContent="Skip-Day nutzen";
        skip.addEventListener("click", async ()=>{
          const r = await fetch("/api/skip",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({person:key})
          });
          const data = await r.json();
          if (data.warning) alert(data.warning);
          loadAndRender();
        });
        cont.appendChild(skip);

        const cant = document.createElement("div");
        cant.className="cant-btn";
        cant.textContent="Ich kann nicht mehr";
        cant.addEventListener("click", async ()=>{
          const pw = prompt("Passwort eingeben:");
          if (!pw) return;
          const r = await fetch("/api/reps_reduce",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({person:key,password:pw})
          });
          if (!r.ok){
            alert("Falsches Passwort. Nett versucht.");
            return;
          }
          loadAndRender();
        });
        cont.appendChild(cant);

      }
    }

    function updateStatus(s){
      const m = Object.values(s.male).every(Boolean);
      const f = Object.values(s.female).every(Boolean);
      const out = document.getElementById("overallStatus");

      if (m && f){
        out.innerHTML = "<span class='done'>Beide fertig. Sch√∂n w√§r‚Äôs, wenn das immer so w√§re.</span>";
      } else if (m && !f){
        out.innerHTML = `<span class='wait'>${rot(maleDone,"idxMale")}</span>`;
      } else if (!m && f){
        out.innerHTML = `<span class='wait'>${rot(femaleDone,"idxFem")}</span>`;
      } else {
        out.innerHTML = `<span class='wait'>${rot(nobody,"idxNobody")}</span>`;
      }
    }

    async function loadAndRender(){
      const s = await fetchState();
      document.getElementById("day").textContent = s.day;
      document.getElementById("date").textContent = formatDate(s.day);

      const maleRO = clickableFor && clickableFor!=='male';
      const femaleRO = clickableFor && clickableFor!=='female';

      renderPerson("maleExercises","male",s,maleRO);
      renderPerson("femaleExercises","female",s,femaleRO);

      const mDone = Object.values(s.male).every(Boolean);
      const fDone = Object.values(s.female).every(Boolean);
      const btn = document.getElementById("nextDayBtn");
      if (mDone && fDone) btn.classList.remove("disabled");
      else btn.classList.add("disabled");

      updateStatus(s);
    }

    document.getElementById("nextDayBtn").addEventListener("click", async ()=>{
      const btn = document.getElementById("nextDayBtn");
      if (btn.classList.contains("disabled")) return;
      await fetch("/api/next_day",{method:"POST"});
      loadAndRender();
    });

    loadAndRender();
    setInterval(loadAndRender,5000);
    document.addEventListener('visibilitychange',()=>{if(!document.hidden)loadAndRender();});
  </script>
</body>
</html>
