<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Workout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <style>
    :root{
      --male-bg:#e9f2ff; --male-border:#6aa6ff; --male-accent:#2c6cff;
      --female-bg:#ffe9f4; --female-border:#ff86b7; --female-accent:#e33682;
      --ok:#16a34a; --muted:#666;
    }
    html,body{height:100%}
    body{
      font-family:Arial,Helvetica,sans-serif;
      padding:24px;
      background:#fafafa;
      color:#111;
      -webkit-text-size-adjust:100%
    }
    h1{margin:0 0 6px;font-size:2rem;}
    .counter-title{
      margin-top:4px;
      font-size:1.3rem;
      font-weight:700;
      color:#444;
    }
    .overall-box{
      margin:8px 0 18px;
      padding:12px;
      background:#fff;
      border-radius:10px;
      border:1px solid #ddd;
      font-size:0.95rem;
    }
    .overall-row{
      display:flex;
      justify-content:space-between;
      padding:4px 0;
    }
    .overall-person{
      margin-top:6px;
      margin-bottom:4px;
      font-weight:600;
    }
    .text-small{
      font-size:0.85rem;
      color:#666;
    }
    .date-line{
      font-size:1.8rem;
      font-weight:700;
      margin:4px 0 8px;
    }
    .container{display:flex;gap:20px;flex-wrap:wrap}
    .panel{
      border:2px solid #ddd;
      border-radius:12px;
      padding:18px;
      width:340px;
      background:white;
    }
    .panel.male{background:var(--male-bg);border-color:var(--male-border)}
    .panel.female{background:var(--female-bg);border-color:var(--female-border)}
    .panel h2{margin:0 0 10px;font-size:1.4rem}

    .exercise{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin:12px 0;
      padding:12px 10px;
      border-radius:10px;
      background:white;
      cursor:pointer;
      user-select:none;
      border:1px solid #ddd;
    }
    .exercise.done{
      background:#f0fff0;
      border-color:#88cc88;
      color:#1a7f1a;
      font-weight:bold;
    }

    .skip-btn{
      border:1px dashed #bbb;
      padding:10px;
      border-radius:8px;
      margin:10px 0;
      cursor:pointer;
      font-size:0.95rem;
      background:#fff7f0;
    }

    .cant-btn{
      border:1px solid #444;
      padding:10px;
      border-radius:8px;
      margin:10px 0;
      cursor:pointer;
      font-size:0.95rem;
      background:#fff0f0;
      font-weight:bold;
    }

    .hidden{ display:none; }
    .readonly .exercise,
    .readonly .skip-btn,
    .readonly .cant-btn{
      opacity:.5;pointer-events:none;
    }

    .status{margin:12px 0 16px;font-size:1.1rem;font-weight:600}
    .status .done{color:var(--ok)}
    .status .wait{color:#b45309}
    .warning{color:#b91c1c;font-weight:700;margin-top:4px}

    button{
      padding:12px 16px;
      border-radius:12px;
      border:1px solid #ccc;
      background:#fff;
      cursor:pointer;
      font-size:1rem;
      min-height:48px;
    }
    .disabled{opacity:.5;pointer-events:none}

    @media(max-width:768px){
      body{padding:18px;font-size:18px;line-height:1.35}
      h1{font-size:2rem}
      .date-line{font-size:2rem}
      .container{flex-direction:column;gap:16px}
      .panel{width:100%;max-width:none}
    }
  </style>
</head>
<body>
  <h1>Workout</h1>

  <!-- OVERALL COUNTER -->
  <div class="counter-title">Workout-Counter</div>
  <div id="overallBox" class="overall-box"></div>

  <div class="date-line">Heute: <span id="date">–</span></div>
  <div class="muted">Tag: <span id="day">1</span></div>
  <div id="overallStatus" class="status"></div>

  <div class="container">
    <div class="panel male" id="malePanel">
      <h2>Mann</h2>
      <div id="maleExercises"></div>
    </div>

    <div class="panel female" id="femalePanel">
      <h2>Frau</h2>
      <div id="femaleExercises"></div>
    </div>
  </div>

  <div style="margin-top:18px">
    <button id="nextDayBtn" class="disabled">Nächster Tag</button>
  </div>

  <script>
    const START_DATE = new Date('2025-11-12T00:00:00');
    const params = new URLSearchParams(window.location.search);
    const view = params.get('view') || '';
    const whoAmI = view === 'mann' ? 'male' : view === 'frau' ? 'female' : '';

    async function fetchState(){ return (await fetch("/api/state")).json(); }

    const weekdays=["So","Mo","Di","Mi","Do","Fr","Sa"];

    function formatDate(day){
      const d=new Date(START_DATE.getTime());
      d.setDate(d.getDate()+(day-1));
      return `${weekdays[d.getDay()]}, ${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`;
    }

    // SPRÜCHE
    const nobody=[/* 20 Sprüche wie zuvor (gekürzt hier) */ 
      "Niemand fertig. Ein Wunder, dass überhaupt jemand hier ist.",
      "Stimmung: 0% Training, 100% Ausreden.",
      "Alle am Leben. Niemand am Trainieren.",
      "Der Schweinehund führt klar nach Punkten.",
      "Niemand fertig. Dafür maximale Schonhaltung.",
      "Hier trainiert heute nur die Geduld."
    ];

    const maleDone=[
      "Mann fertig, Frau auf spiritueller Trainingsreise.",
      "Mann liefert, Frau liefert Kaffee.",
      "Mann done, Frau dont.",
      "Mann schwitzt, Frau sitzt.",
      "Mann stark, Frau denkt noch nach."
    ];

    const femaleDone=[
      "Frau fertig, Mann sucht Ausreden.",
      "Frau liefert, Mann verwirrt.",
      "Frau top, Mann stopp.",
      "Frau gewinnt, Mann spinnt.",
      "Frau stark, Mann snackt."
    ];

    let idxNobody=0, idxMale=0, idxFem=0;
    function rot(arr, key){
      const i = window[key] % arr.length;
      window[key]++; 
      return arr[i];
    }


    function renderOverall(s){
      const box = document.getElementById("overallBox");
      box.innerHTML="";

      ["male","female"].forEach(p=>{
        const pname = p==="male" ? "Mann" : "Frau";
        const div = document.createElement("div");
        div.className="overall-person";
        div.textContent = pname;
        box.appendChild(div);

        ["squats","situps","pushups"].forEach(ex=>{
          const row = document.createElement("div");
          row.className="overall-row";
          let label = ex==="squats" ? "Squats" : ex==="situps" ? "Situps" : "Push Ups";
          row.innerHTML = `
            <span>${label}</span>
            <span>${s.overall[p][ex]} reps total</span>`;
          box.appendChild(row);
        });
      });
    }


    function renderPerson(containerId, key, s){
      const cont=document.getElementById(containerId);
      cont.innerHTML="";

      const reps=s.reps[key];
      const canClick = (whoAmI === key);

      ["squats","situps","pushups"].forEach(ex=>{
        const row=document.createElement("div");
        row.className="exercise"+(s[key][ex]?" done":"");

        let label = ex==="squats"?"Squats":ex==="situps"?"Situps":"Push Ups";

        row.innerHTML=`
          <span>${label}</span>
          <strong>${reps[ex]}x</strong>
        `;

        if (canClick){
          row.addEventListener("click",async()=>{
            await fetch("/api/toggle",{
              method:"POST",
              headers:{"Content-Type":"application/json"},
              body:JSON.stringify({person:key,exercise:ex})
            });
            loadAndRender();
          });
        }

        cont.appendChild(row);
      });

      // SKIP BUTTON – nur sichtbar wenn ich selbst bin ODER die Person heute geskipped hat
      const skippedToday = s.skip[key].includes(s.day);
      if (canClick || skippedToday){
        const skip=document.createElement("div");
        skip.className="skip-btn";
        skip.textContent="Skip-Day nutzen";
        if (!canClick) skip.classList.add("readonly");

        skip.addEventListener("click",async()=>{
          if (!canClick) return;
          const r = await fetch("/api/skip",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({person:key})
          });
          const data=await r.json();
          if (data.warning) alert(data.warning);
          loadAndRender();
        });
        cont.appendChild(skip);
      }

      // ICH KANN NICHT MEHR – gleiche Logik
      if (canClick || skippedToday){
        const cant=document.createElement("div");
        cant.className="cant-btn";
        cant.textContent="Ich kann nicht mehr";
        if (!canClick) cant.classList.add("readonly");

        cant.addEventListener("click",async()=>{
          if (!canClick) return;
          const pw=prompt("Passwort eingeben:");
          if (!pw) return;
          const r = await fetch("/api/reps_reduce",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({person:key,password:pw})
          });
          if (!r.ok){
            alert("Falsches Passwort.");
            return;
          }
          loadAndRender();
        });

        cont.appendChild(cant);
      }
    }


    function updateStatus(s){
      const m = Object.values(s.male).every(Boolean);
      const f = Object.values(s.female).every(Boolean);
      const out=document.getElementById("overallStatus");

      if (m && f){
        out.innerHTML="<span class='done'>Beide fertig. Stark!</span>";
      } 
      else if (m && !f){
        out.innerHTML=`<span class='wait'>${rot(femaleDone,"idxFem")}</span>`;
      }
      else if (!m && f){
        out.innerHTML=`<span class='wait'>${rot(maleDone,"idxMale")}</span>`;
      }
      else{
        out.innerHTML=`<span class='wait'>${rot(nobody,"idxNobody")}</span>`;
      }
    }


    async function loadAndRender(){
      const s = await fetchState();
      document.getElementById("day").textContent=s.day;
      document.getElementById("date").textContent=formatDate(s.day);

      renderOverall(s);

      renderPerson("maleExercises","male",s);
      renderPerson("femaleExercises","female",s);

      const mDone=Object.values(s.male).every(Boolean);
      const fDone=Object.values(s.female).every(Boolean);
      const btn=document.getElementById("nextDayBtn");
      if (mDone && fDone) btn.classList.remove("disabled");
      else btn.classList.add("disabled");

      updateStatus(s);
    }

    document.getElementById("nextDayBtn").addEventListener("click",async()=>{
      const btn=document.getElementById("nextDayBtn");
      if (btn.classList.contains("disabled")) return;
      await fetch("/api/next_day",{method:"POST"});
      loadAndRender();
    });

    loadAndRender();
    setInterval(loadAndRender,5000);
    document.addEventListener('visibilitychange',()=>{ if(!document.hidden) loadAndRender(); });
  </script>
</body>
</html>
