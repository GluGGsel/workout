<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <title>Workout-Counter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <!-- Dynamisches Manifest abhÃ¤ngig von ?view= -->
    <link rel="manifest" href="/static/{{ manifest_file }}">

    <!-- iOS Icons -->
    <link rel="apple-touch-icon" sizes="192x192" href="/static/icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/static/icons/icon-512.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
            margin: 0;
        }
        h1 {
            margin: 0 0 8px;
        }
        #dateLine {
            font-size: 0.95rem;
            color: #555;
            margin-bottom: 4px;
        }
        #activeInfo {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 12px;
        }
        .container {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .card {
            padding: 16px;
            border-radius: 10px;
            flex: 1;
            min-width: 260px;
            box-sizing: border-box;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        .male {
            background: #e9f2ff;
            border: 2px solid #6aa6ff;
        }
        .female {
            background: #ffe9f4;
            border: 2px solid #ff86b7;
        }
        .card h2 {
            margin: 0 0 6px;
        }
        .totals {
            margin: 4px 0 10px;
            font-size: 0.88rem;
            color: #333;
        }
        .totals strong {
            display: block;
            margin-bottom: 2px;
        }
        .exercise-list {
            margin-top: 4px;
            margin-bottom: 10px;
        }
        .exercise {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            padding: 6px 8px;
            border-radius: 6px;
        }
        .exercise.clickable {
            cursor: pointer;
        }
        .exercise.clickable:hover {
            background: rgba(0,0,0,0.04);
        }
        .exercise-label {
            flex: 1;
            font-weight: bold;
            font-size: 0.95rem;
        }
        .exercise small {
            display: block;
            font-weight: normal;
            font-size: 0.8rem;
            color: #555;
        }
        .exercise input[type="checkbox"] {
            cursor: pointer;
        }
        .exercise input[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
        }
        button {
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 6px;
            border: none;
            font-size: 0.85rem;
        }
        button[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-skip {
            background: #ffe6b3;
        }
        .btn-injured {
            background: #ffd6d6;
        }
        .btn-cant {
            background: #e1e1ff;
        }
        .status-line {
            margin-top: 6px;
            font-size: 0.8rem;
            color: #444;
        }
        #phraseBox, #statusBox {
            margin: 15px 0;
            padding: 12px;
            border-radius: 8px;
        }
        #phraseBox {
            background: #fffbe6;
            border: 1px solid #f0d14a;
        }
        #statusBox {
            background: #eef9ff;
            border: 1px solid #8cc6ff;
            font-size: 0.9rem;
        }
        #nextDayBtn {
            margin-top: 10px;
            padding: 8px 14px;
            border-radius: 8px;
            border: none;
            background: #4caf50;
            color: white;
            font-weight: bold;
        }
        #nextDayBtn:hover {
            filter: brightness(1.05);
        }
        @media (max-width: 700px) {
            .container {
                flex-direction: column;
            }
        }
    </style>

</head>
<body>

<h1>Workout</h1>
<div id="dateLine"></div>
<div id="activeInfo"></div>

<div class="container">
    <div class="card male">
        <h2 id="maleNameHeading">{{ male_name }}</h2>
        <div class="totals" id="maleTotals"></div>
        <div class="exercise-list" id="maleExercises"></div>
        <div class="actions" id="maleActions"></div>
        <div class="status-line" id="maleStatus"></div>
    </div>

    <div class="card female">
        <h2 id="femaleNameHeading">{{ female_name }}</h2>
        <div class="totals" id="femaleTotals"></div>
        <div class="exercise-list" id="femaleExercises"></div>
        <div class="actions" id="femaleActions"></div>
        <div class="status-line" id="femaleStatus"></div>
    </div>
</div>

<div id="phraseBox">
    <strong>Spruch des Tages:</strong>
    <div id="phraseText"></div>
</div>

<div id="statusBox" style="display:none;">
    <strong>Status:</strong>
    <div id="statusText"></div>
</div>

<button id="nextDayBtn">NÃ¤chster Tag</button>

<script>
(function () {
    // ---- Konfiguration ----
    var maleName = {{ male_name|tojson }};
    var femaleName = {{ female_name|tojson }};
    var activePerson = {{ active_person|tojson }};

    var EXERCISES = ["squats", "situps", "pushups"];
    var LABELS = {
        squats: "Squats",
        situps: "Crunches",
        pushups: "Pushups"
    };

    var phrases = null;

    // ---- Hilfsfunktionen ----
    function formatDateDE(isoDate) {
        if (!isoDate) return "";
        var parts = isoDate.split("-");
        if (parts.length !== 3) return isoDate;
        return parts[2] + "." + parts[1] + "." + parts[0];
    }

    function randItem(arr) {
        if (!arr || !arr.length) return null;
        var idx = Math.floor(Math.random() * arr.length);
        return arr[idx];
    }

    function personalizePhrase(phrase, ctx) {
        if (!phrase) return "";
        var context = ctx || {};
        var result = phrase;

        result = result.replace(/{{MANN}}/g, maleName);
        result = result.replace(/{{FRAU}}/g, femaleName);

        if (context.doneName) {
            result = result.replace(/{{DONE}}/g, context.doneName);
        }
        if (context.otherName) {
            result = result.replace(/{{OTHER}}/g, context.otherName);
        }
        if (context.name) {
            result = result.replace(/{{NAME}}/g, context.name);
        }
        if (context.actor) {
            result = result.replace(/{{ACTOR}}/g, context.actor);
        }

        return result;
    }

    function isDayClosedForPerson(state, person) {
        var day = state.day;
        var doneAll = true;
        for (var i = 0; i < EXERCISES.length; i++) {
            var ex = EXERCISES[i];
            if (!state.done[person] || !state.done[person][ex]) {
                doneAll = false;
                break;
            }
        }
        var skipped = state.skip[person] && state.skip[person].indexOf(day) !== -1;
        var injured = state.injured[person] && state.injured[person].indexOf(day) !== -1;
        var cant = state.cant[person] && state.cant[person].indexOf(day) !== -1;
        return doneAll || skipped || injured || cant;
    }

    function setStatusMessage(phrase) {
        var box = document.getElementById("statusBox");
        var text = document.getElementById("statusText");
        if (phrase && phrase.trim() !== "") {
            text.textContent = phrase;
            box.style.display = "block";
        } else {
            text.textContent = "";
            box.style.display = "none";
        }
    }

    // ---- Backend-Aufrufe (Promises, kein async/await) ----
    function fetchJSON(url, options) {
        return fetch(url, options || {}).then(function (res) {
            return res.json().then(function (data) {
                return { ok: res.ok, status: res.status, data: data };
            })["catch"](function () {
                return { ok: res.ok, status: res.status, data: null };
            });
        });
    }

    function loadPhrasesIfNeeded() {
        if (phrases) {
            return Promise.resolve();
        }
        return fetch("/static/phrases.json").then(function (res) {
            if (!res.ok) {
                console.error("Konnte phrases.json nicht laden");
                phrases = {};
                return;
            }
            return res.json().then(function (data) {
                phrases = data;
            });
        })["catch"](function (e) {
            console.error("Fehler beim Laden von phrases.json", e);
            phrases = {};
        });
    }

    function markDone(person, exercise) {
        if (person !== activePerson) return;
        return fetchJSON("/api/done", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ person: person, exercise: exercise })
        }).then(function (res) {
            if (!res.ok) {
                alert("Fehler beim Speichern â€“ Server zickt rum.");
                return;
            }
            return load();
        })["catch"](function (e) {
            console.error(e);
            alert("Netzwerkfehler â€“ Internet auch im Training faul?");
        });
    }

    function handleSkip(person) {
        var name = person === "male" ? maleName : femaleName;
        return fetchJSON("/api/skip", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ person: person })
        }).then(function (res) {
            if (res.data && res.data.status === "cheater") {
                var pool = (phrases && phrases.cheater) || [];
                var raw = randItem(pool) || "{{NAME}} wollte schon wieder schummeln. Nice try.";
                var txt = personalizePhrase(raw, { name: name });
                setStatusMessage(txt);
            } else if (res.data && res.data.status === "ok") {
                var pool2 = (phrases && phrases.skip_day) || [];
                var raw2 = randItem(pool2) || "{{NAME}} hat heute offiziell einen Ehren-Faulheitstag.";
                var txt2 = personalizePhrase(raw2, { name: name });
                setStatusMessage(txt2);
            } else {
                alert("Unerwartete Antwort vom Server.");
            }
            return load();
        })["catch"](function (e) {
            console.error(e);
            alert("Netzwerkfehler bei Skip.");
        });
    }

    function handleInjured(person) {
        var name = person === "male" ? maleName : femaleName;
        return fetchJSON("/api/injured", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ person: person })
        }).then(function (res) {
            if (!res.ok) {
                alert("Fehler beim Krank-Setzen.");
                return;
            }
            var pool = (phrases && phrases.injured_day) || [];
            var raw = randItem(pool) || "{{NAME}} ist heute offiziell kaputtgemeldet.";
            var txt = personalizePhrase(raw, { name: name });
            setStatusMessage(txt);
            return load();
        })["catch"](function (e) {
            console.error(e);
            alert("Netzwerkfehler bei Krank.");
        });
    }

    function handleCant(person) {
        var name = person === "male" ? maleName : femaleName;
        var pw = window.prompt("Passwort fÃ¼r â€žIch kann nicht mehrâ€œ:");
        if (pw === null) return;

        return fetchJSON("/api/cant", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ person: person, password: pw })
        }).then(function (res) {
            var data = res.data || {};
            if (res.status === 403 && data.status === "wrong_password") {
                alert("Falsches Passwort. So schwach wie die Ausrede.");
                return;
            }
            if (data.status === "cheater") {
                var pool = (phrases && phrases.cheater) || [];
                var raw = randItem(pool) || "{{NAME}} wollte schon wieder die Reps ertrÃ¤nken.";
                var txt = personalizePhrase(raw, { name: name });
                setStatusMessage(txt);
            } else if (data.status === "ok") {
                var pool2 = (phrases && phrases.cant_day) || [];
                var fallback = "{{NAME}} hat heute offiziell die Notbremse gezogen. Reps runter, Stolz hoch.";
                var raw2 = randItem(pool2) || fallback;
                var txt2 = personalizePhrase(raw2, { name: name });
                setStatusMessage(txt2);
            } else {
                alert("Unerwartete Antwort vom Server.");
            }
            return load();
        })["catch"](function (e) {
            console.error(e);
            alert("Netzwerkfehler bei â€žIch kann nicht mehrâ€œ.");
        });
    }

    // ---- Renderfunktionen ----
    function renderDateLine(state) {
        var dateLine = document.getElementById("dateLine");
        var activeInfo = document.getElementById("activeInfo");

        var formatted = state.current_weekday + ", " +
            formatDateDE(state.current_date) + " â€“ Tag " + state.day;
        dateLine.textContent = formatted;

        var activeLabel = activePerson === "male" ? maleName : femaleName;
        activeInfo.textContent = "Aktive Ansicht: " + activeLabel + " â€“ nur hier sind die Buttons klickbar.";
    }

    function renderTotals(state, person) {
        var boxId = person === "male" ? "maleTotals" : "femaleTotals";
        var box = document.getElementById(boxId);

        var overall = state.overall[person];
        var skips = (state.skip[person] || []).length;
        var injured = (state.injured[person] || []).length;
        var cant = (state.cant[person] || []).length;

        var crunchesTotal = overall.situps || 0;
        var pushupsTotal = overall.pushups || 0;
        var squatsTotal = overall.squats || 0;

        box.innerHTML =
            "<strong>Total seit " + formatDateDE(state.start_date) + ":</strong> " +
            "Crunches: " + crunchesTotal + "x Â· " +
            "Pushups: " + pushupsTotal + "x Â· " +
            "Squats: " + squatsTotal + "x Â· " +
            "Skips: " + skips + " Â· " +
            "Krank: " + injured + " Â· " +
            "Reduktionen: " + cant;
    }

    function renderExercises(state, person) {
        var exBoxId = person === "male" ? "maleExercises" : "femaleExercises";
        var actionsBoxId = person === "male" ? "maleActions" : "femaleActions";
        var statusLineId = person === "male" ? "maleStatus" : "femaleStatus";

        var exBox = document.getElementById(exBoxId);
        var actionsBox = document.getElementById(actionsBoxId);
        var statusLine = document.getElementById(statusLineId);

        exBox.innerHTML = "";
        actionsBox.innerHTML = "";
        statusLine.textContent = "";

        var isActive = (person === activePerson);
        var day = state.day;

        var skippedToday = state.skip[person] && state.skip[person].indexOf(day) !== -1;
        var injuredToday = state.injured[person] && state.injured[person].indexOf(day) !== -1;
        var cantToday = state.cant[person] && state.cant[person].indexOf(day) !== -1;

        var doneAll = true;
        for (var i = 0; i < EXERCISES.length; i++) {
            var ex = EXERCISES[i];
            if (!state.done[person] || !state.done[person][ex]) {
                doneAll = false;
                break;
            }
        }

        var canInteractExercises = isActive && !skippedToday && !injuredToday && !cantToday;

        for (var j = 0; j < EXERCISES.length; j++) {
            var ex2 = EXERCISES[j];

            var wrapper = document.createElement("div");
            wrapper.className = "exercise";

            var label = document.createElement("div");
            label.className = "exercise-label";

            var reps = state.reps[person][ex2];
            label.innerHTML = "âœ… " + LABELS[ex2] + ": " + reps + "x";

            var detail = document.createElement("small");
            detail.textContent = state.done[person][ex2] ? "Erledigt" : "Noch offen";
            label.appendChild(detail);

            var checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.checked = !!state.done[person][ex2];
            checkbox.disabled = !canInteractExercises || state.done[person][ex2];
            checkbox.title = isActive
                ? "Als erledigt markieren"
                : "Nur auf der eigenen Ansicht abhakbar";

            wrapper.appendChild(checkbox);
            wrapper.appendChild(label);

            if (canInteractExercises && !state.done[person][ex2]) {
                (function (personInner, exInner, cbInner, wrapperInner) {
                    wrapperInner.classList.add("clickable");
                    wrapperInner.addEventListener("click", function () {
                        if (!cbInner.disabled) {
                            markDone(personInner, exInner);
                        }
                    });
                    cbInner.addEventListener("click", function (event) {
                        event.stopPropagation();
                        if (!cbInner.disabled) {
                            markDone(personInner, exInner);
                        }
                    });
                })(person, ex2, checkbox, wrapper);
            }

            exBox.appendChild(wrapper);
        }

        if (skippedToday) {
            statusLine.textContent = "Status heute: ðŸ˜´ Skip markiert.";
        } else if (injuredToday) {
            statusLine.textContent = "Status heute: ðŸ¤’ Krank/Verletzt markiert.";
        } else if (cantToday) {
            statusLine.textContent = "Status heute: ðŸ˜µâ€ðŸ’« Reps reduziert mit â€žIch kann nicht mehrâ€œ.";
        } else if (doneAll) {
            statusLine.textContent = "Status heute: âœ… Alle Ãœbungen erledigt.";
        } else {
            statusLine.textContent = "Status heute: â³ Noch offen.";
        }

        var skipBtn = document.createElement("button");
        skipBtn.className = "btn-skip";
        skipBtn.textContent = "ðŸ˜´ Skip";
        skipBtn.disabled = !isActive || skippedToday || injuredToday || cantToday;
        skipBtn.title = isActive
            ? "Fauler Tag eintragen (wenn erlaubt)"
            : "Nur auf der eigenen Ansicht klickbar";
        skipBtn.addEventListener("click", function () {
            handleSkip(person);
        });

        var injBtn = document.createElement("button");
        injBtn.className = "btn-injured";
        injBtn.textContent = "ðŸ¤’ Krank";
        injBtn.disabled = !isActive || skippedToday || injuredToday || cantToday;
        injBtn.title = isActive
            ? "Krank/Verletzt eintragen"
            : "Nur auf der eigenen Ansicht klickbar";
        injBtn.addEventListener("click", function () {
            handleInjured(person);
        });

        var cantBtn = document.createElement("button");
        cantBtn.className = "btn-cant";
        cantBtn.textContent = "ðŸ˜µâ€ðŸ’« Ich kann nicht mehr";
        cantBtn.disabled = !isActive || cantToday || skippedToday || injuredToday;
        cantBtn.title = isActive
            ? "Reps mit Passwort brutal reduzieren"
            : "Nur auf der eigenen Ansicht klickbar";
        cantBtn.addEventListener("click", function () {
            handleCant(person);
        });

        actionsBox.appendChild(skipBtn);
        actionsBox.appendChild(injBtn);
        actionsBox.appendChild(cantBtn);
    }

    function renderDailyPhrase(state) {
        if (!phrases) return;

        var maleClosed = isDayClosedForPerson(state, "male");
        var femaleClosed = isDayClosedForPerson(state, "female");

        var pool = phrases.none_done || [];
        var ctx = {};

        if (maleClosed && femaleClosed) {
            pool = phrases.all_done || [];
        } else if (!maleClosed && !femaleClosed) {
            pool = phrases.none_done || [];
        } else {
            pool = phrases.one_done || [];
            var doneName = maleClosed ? maleName : femaleName;
            var otherName = maleClosed ? femaleName : maleName;
            ctx = { doneName: doneName, otherName: otherName };
        }

        var phrase = personalizePhrase(randItem(pool), ctx);
        document.getElementById("phraseText").textContent = phrase || "";
    }

    // ---- Haupt-Load ----
    function load() {
        return loadPhrasesIfNeeded()
            .then(function () {
                return fetchJSON("/api/state");
            })
            .then(function (res) {
                if (!res.ok) {
                    alert("Fehler beim Laden des Zustands.");
                    return;
                }
                var state = res.data;

                renderDateLine(state);
                renderTotals(state, "male");
                renderTotals(state, "female");
                renderExercises(state, "male");
                renderExercises(state, "female");
                renderDailyPhrase(state);
            })["catch"](function (e) {
                console.error(e);
                alert("Allgemeiner Fehler beim Laden.");
            });
    }

    // ---- NÃ¤chster Tag Button ----
    document.getElementById("nextDayBtn").addEventListener("click", function () {
        fetchJSON("/api/nextday", { method: "POST" })
            .then(function (res) {
                if (!res.ok) {
                    var data = res.data || {};
                    alert(data.error || "Noch nicht alle fertig oder markiert.");
                    return;
                }
                setStatusMessage("");
                return load();
            })["catch"](function (e) {
                console.error(e);
                alert("Fehler beim Wechsel auf den nÃ¤chsten Tag.");
            });
    });

    // Initialer Start
    load();
})();
</script>

</body>
</html>
