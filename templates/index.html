<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Workout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <style>
    :root{
      --male-bg:#e9f2ff; --male-border:#6aa6ff; --male-accent:#2c6cff;
      --female-bg:#ffe9f4; --female-border:#ff86b7; --female-accent:#e33682;
      --ok:#16a34a; --muted:#666;
    }
    html,body{height:100%}
    body{
      font-family:Arial,Helvetica,sans-serif;
      padding:24px;
      background:#fafafa;
      color:#111;
      -webkit-text-size-adjust:100%
    }
    h1{margin:0 0 6px;font-size:2rem;}
    .muted{color:var(--muted);font-size:1rem;margin:4px 0 16px}
    .counter-title{
      margin-top:4px;
      font-size:1.3rem;
      font-weight:700;
      color:#444;
    }
    .overall-box{
      margin:8px 0 18px;
      padding:12px;
      background:#fff;
      border-radius:10px;
      border:1px solid #ddd;
      font-size:0.95rem;
    }
    .overall-person{
      margin-top:6px;
      margin-bottom:4px;
      font-weight:600;
    }
    .overall-row{
      display:flex;
      justify-content:space-between;
      padding:3px 0;
    }
    .text-small{
      font-size:0.85rem;
      color:#666;
      margin-bottom:6px;
    }
    .date-line{
      font-size:1.8rem;
      font-weight:700;
      margin:4px 0 8px;
    }
    .container{display:flex;gap:20px;flex-wrap:wrap}
    .panel{
      border:2px solid #ddd;
      border-radius:12px;
      padding:18px;
      width:340px;
      background:white;
    }
    .panel.male{background:var(--male-bg);border-color:var(--male-border)}
    .panel.female{background:var(--female-bg);border-color:var(--female-border)}
    .panel h2{margin:0 0 10px;font-size:1.4rem}

    .exercise{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin:10px 0;
      padding:10px;
      border-radius:10px;
      background:white;
      cursor:pointer;
      user-select:none;
      border:1px solid #ddd;
    }
    .exercise.done{
      background:#f0fff0;
      border-color:#88cc88;
      color:#1a7f1a;
      font-weight:bold;
    }
    .exercise.injured{
      background:#fff5f5;
      border-color:#f97373;
      color:#b91c1c;
      font-weight:bold;
    }
    .exercise.injured strong{
      color:#b91c1c;
    }

    .skip-btn,
    .injured-btn,
    .cant-btn{
      padding:10px;
      border-radius:8px;
      margin:8px 0;
      cursor:pointer;
      font-size:0.95rem;
    }
    .skip-btn{
      border:1px dashed #bbb;
      background:#fff7f0;
    }
    .injured-btn{
      border:1px dashed #f97373;
      background:#fff0f0;
    }
    .cant-btn{
      border:1px solid #444;
      background:#ffecec;
      font-weight:bold;
    }

    .readonly{
      opacity:.6;pointer-events:none;
    }
    .hidden{display:none;}

    .status{margin:12px 0 16px;font-size:1.1rem;font-weight:600}
    .status .done{color:var(--ok)}
    .status .wait{color:#b45309}
    .warning{color:#b91c1c;font-weight:700;margin-top:4px}

    button{
      padding:12px 16px;
      border-radius:12px;
      border:1px solid #ccc;
      background:#fff;
      cursor:pointer;
      font-size:1rem;
      min-height:48px;
    }
    .disabled{opacity:.5;pointer-events:none}

    @media(max-width:768px){
      body{padding:18px;font-size:18px;line-height:1.35}
      h1{font-size:2rem}
      .date-line{font-size:2rem}
      .container{flex-direction:column;gap:16px}
      .panel{width:100%;max-width:none}
    }
  </style>
</head>
<body>
  <h1>Workout</h1>

  <div class="counter-title">Workout-Counter</div>
  <div id="overallBox" class="overall-box"></div>

  <div class="date-line">Heute: <span id="date">–</span></div>
  <div class="muted">Tag: <span id="day">1</span></div>
  <div id="overallStatus" class="status"></div>

  <div class="container">
    <div class="panel male" id="malePanel">
      <h2>Mann</h2>
      <div id="maleExercises"></div>
    </div>

    <div class="panel female" id="femalePanel">
      <h2>Frau</h2>
      <div id="femaleExercises"></div>
    </div>
  </div>

  <div style="margin-top:18px">
    <button id="nextDayBtn" class="disabled">Nächster Tag</button>
  </div>

  <script>
    const START_DATE = new Date('2025-11-12T00:00:00');
    const params = new URLSearchParams(window.location.search);
    const view = (params.get('view') || '').toLowerCase();
    const whoAmI = view === 'mann' ? 'male' : view === 'frau' ? 'female' : '';

    async function fetchState(){ return (await fetch("/api/state")).json(); }

    const weekdays = ["So","Mo","Di","Mi","Do","Fr","Sa"];

    function formatDate(day){
      const d = new Date(START_DATE.getTime());
      d.setDate(d.getDate() + (day - 1));
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      return `${weekdays[d.getDay()]}, ${dd}.${mm}.${yyyy}`;
    }

    // Zynische Sprüche
    const nobody = [
      "Niemand fertig. Wenigstens sind die Ausreden gut trainiert.",
      "Status: 0% Training, 100% Aufschieben.",
      "Alle da, keiner fertig. Klassischer Team-Erfolg.",
      "Heute wird anscheinend nur die Couch belastet.",
      "Niemand fertig, aber alle mental überfordert.",
      "Der Schweinehund hat klar gewonnen.",
      "Mehr Aktivität im WLAN als in den Muskeln.",
      "Niemand fertig. Aber die Hoffnung stirbt… morgen.",
      "Trainingsstand: tief, Motivation: im Keller.",
      "Alle warten auf den perfekten Moment. Der war vor drei Stunden.",
      "Niemand fertig. Vielleicht war heute nur Aufwärmen für morgen.",
      "Noch kein Häkchen, aber viel Potenzial zum Schönreden.",
      "Niemand fertig. Das ist schon fast konsequent.",
      "Die Stoppuhr läuft, der Puls nicht.",
      "Niemand fertig. Aber Hauptsache, die Ausreden sind individuell.",
      "Hier wurde heute nur die Selbsttäuschung bewegt.",
      "Trainingslevel: Tutorial übersprungen.",
      "Niemand fertig, aber Kalorienverbrauch beim Jammern steigt.",
      "Niemand fertig. Vielleicht muss erst der Mond richtig stehen.",
      "Alle tun ihr Bestes, nichts zu tun."
    ];

    const maleDone = [
      "Frau ist fertig, Mann sucht noch nach der perfekten Ausrede.",
      "Frau liefert, Mann liefert Argumente.",
      "Frau schwitzt, Mann sitzt.",
      "Frau top, Mann stopp.",
      "Frau stark, Mann snackt.",
      "Frau durch, Mann fast – aber nur mit den Nerven.",
      "Frau macht Wiederholungen, Mann macht Pausen.",
      "Frau fertig, Mann studiert noch YouTube-Tutorials.",
      "Frau rockt, Mann lockt … die Couch.",
      "Frau im Trainingsmodus, Mann im Schonmodus.",
      "Frau ackert, Mann analysiert.",
      "Frau durch, Mann diskutiert mit seinem Schweinehund.",
      "Frau kämpft, Mann denkt intensiv über Sport nach.",
      "Frau macht Gains, Mann macht Geräusche.",
      "Frau fertig, Mann in schwerer Verhandlung mit der Schwerkraft.",
      "Frau liefert ab, Mann liefert nach: irgendwann.",
      "Frau stabil, Mann fragil.",
      "Frau motiviert, Mann verwirrt.",
      "Frau finish, Mann fängt gleich an. Ehrlich.",
      "Frau erledigt, Mann erledigt – aber vom Zuschauen."
    ];

    const femaleDone = [
      "Mann ist fertig, Frau justiert noch die Motivation.",
      "Mann liefert, Frau liefert Kaffee.",
      "Mann schwitzt, Frau sitzt.",
      "Mann top, Frau stopp.",
      "Mann stark, Frau plant.",
      "Mann durch, Frau noch im Ladebildschirm.",
      "Mann macht Reps, Frau macht Pläne.",
      "Mann fertig, Frau spricht mit ihrem inneren Schweinehund.",
      "Mann trainiert, Frau moderiert.",
      "Mann in Bewegung, Frau in Beratung.",
      "Mann ackert, Frau sortiert Ausreden.",
      "Mann fertig, Frau studiert noch die Sterne.",
      "Mann liefert, Frau überlegt, ob heute überhaupt existiert.",
      "Mann kämpft, Frau kommentiert.",
      "Mann done, Frau don’t – noch.",
      "Mann stark, Frau strategisch passiv.",
      "Mann fertig, Frau in tiefem Gespräch mit der Couch.",
      "Mann gewinnt, Frau taktiert.",
      "Mann ready, Frau maybe.",
      "Mann rennt, Frau denkt."
    ];

    const praiseMale = [
      "Mann hat schon {{total}} Reps gesammelt. Knie sind beeindruckt, Ausreden beleidigt.",
      "Schon {{total}} Wiederholungen. Irgendwer nimmt das hier ernst.",
      "{{total}} Reps – nicht schlecht für jemanden, der angeblich müde ist.",
      "Mit {{total}} Reps ist der Mann offiziell nicht mehr im Anfänger-Modus.",
      "{{total}} Wiederholungen. Langsam wird das peinlich für den inneren Schweinehund.",
      "Mann bei {{total}} Reps. Das ist mehr als viele in einem ganzen Monat schaffen.",
      "{{total}} Reps – offenbar kann er doch mehr als jammern.",
      "Mit {{total}} Wiederholungen hat der Mann das Recht auf eine sehr große Mahlzeit.",
      "{{total}} Reps. Wahrscheinlich merkt der Körper das morgen.",
      "Mann auf {{total}} Reps. So langsam wird's ernst.",
      "{{total}} Mal hoch, runter, irgendwas. Hauptsache erledigt.",
      "Der Zähler steht bei {{total}}. Faul ist was anderes.",
      "{{total}} Wiederholungen – Respekt. Und ja, du musst weitermachen.",
      "Mann hat {{total}} Reps geballert. Die Couch vermisst ihn.",
      "{{total}} Reps. Nicht perfekt, aber eindeutig nicht faul.",
      "Mit {{total}} Wiederholungen wirkt die 'Ich kann nicht mehr'-Nummer eher süß.",
      "{{total}} Reps – die Ausreden sollten langsam verstummen.",
      "Mann auf {{total}} Reps. Noch ein bisschen, dann wird’s richtig unangenehm.",
      "{{total}} Wiederholungen. Gut, jetzt darf er kurz jammern.",
      "{{total}} Reps – das ist schon fast ein erwachsenes Trainingsverhalten."
    ];

    const praiseFemale = [
      "Frau hat schon {{total}} Reps. Die Motivation gewinnt eindeutig.",
      "{{total}} Wiederholungen – und trotzdem funktionstüchtig. Beeindruckend.",
      "Mit {{total}} Reps ist sie offiziell die zuverlässigere Hälfte.",
      "{{total}} Reps. Die Couch ist beleidigt, aber stolz.",
      "Frau bei {{total}} Wiederholungen. Da kann man 'faul' offiziell streichen.",
      "{{total}} Reps – das ist keine Spielerei mehr.",
      "Mit {{total}} Wiederholungen hat sie dem inneren Schweinehund die Stirn geboten.",
      "{{total}} Reps. Das Ego darf zurecht größer werden.",
      "Frau steht bei {{total}} Reps. Stabiler als mancher Trainingsplan.",
      "{{total}} Wiederholungen – das ist mehr Einsatz als viele in einer Woche schaffen.",
      "Bei {{total}} Reps darf man leise an Muskelkater denken.",
      "{{total}} Reps: Disziplinstufe 'Beeindruckend'.",
      "Frau rockt {{total}} Wiederholungen. Der Rest der Welt scrollt.",
      "{{total}} Reps. Wenn das so weitergeht, braucht sie bald neue Ausreden.",
      "Mit {{total}} Wiederholungen ist sie weit jenseits von 'Ich fang morgen an'.",
      "{{total}} Reps – das ist nicht mehr Hobby, das ist Statement.",
      "Frau bei {{total}} Wiederholungen. Der Schweinehund weint leise.",
      "{{total}} Reps. Wenn er mithalten will, muss er sich beeilen.",
      "Mit {{total}} Wiederholungen ist sie offiziell im 'Kein-Witz-mehr'-Bereich.",
      "{{total}} Reps. Dazu passt: weniger reden, mehr staunen."
    ];

    let idxNobody=0, idxMale=0, idxFem=0, idxPM=0, idxPF=0;
    function rot(arr, key){
      const i = window[key] % arr.length;
      window[key]++;
      return arr[i];
    }

    function renderOverall(s){
      const box = document.getElementById("overallBox");
      box.innerHTML = "";

      ["male","female"].forEach(p=>{
        const pname = p==="male" ? "Mann" : "Frau";
        const div = document.createElement("div");
        div.className = "overall-person";
        div.textContent = pname;
        box.appendChild(div);

        let total = 0;
        ["squats","situps","pushups"].forEach(ex=>{
          const row = document.createElement("div");
          row.className = "overall-row";
          const label = ex==="squats" ? "Squats" : ex==="situps" ? "Situps" : "Push Ups";
          const val = s.overall[p][ex] || 0;
          total += val;
          row.innerHTML = `<span>${label}</span><span>${val} reps total</span>`;
          box.appendChild(row);
        });

        const praise = document.createElement("div");
        praise.className = "text-small";
        if (total === 0){
          praise.textContent = "Noch keine Reps. Aktuell gewinnt die Bequemlichkeit.";
        } else {
          let msg;
          if (p==="male"){
            msg = rot(praiseMale,"idxPM");
          } else {
            msg = rot(praiseFemale,"idxPF");
          }
          praise.textContent = msg.replace("{{total}}", total);
        }
        box.appendChild(praise);
      });
    }

    function renderPerson(containerId, key, s){
      const cont = document.getElementById(containerId);
      cont.innerHTML = "";

      const reps = s.reps[key];
      const day = s.day;
      const skippedToday = (s.skip[key] || []).includes(day);
      const injuredToday = (s.injured[key] || []).includes(day);
      const cantToday = (s.cant[key] || []).includes(day);
      const canClick = (whoAmI === key);

      ["squats","situps","pushups"].forEach(ex=>{
        const row = document.createElement("div");
        let cls = "exercise";
        if (s[key][ex]) cls += " done";
        if (injuredToday) cls += " injured";
        row.className = cls;

        const label = ex==="squats" ? "Squats" : ex==="situps" ? "Situps" : "Push Ups";
        const icon = injuredToday ? "✗ " : "";
        row.innerHTML = `
          <span>${label}</span>
          <strong>${icon}${reps[ex]}x</strong>
        `;

        if (canClick){
          row.addEventListener("click", async ()=>{
            await fetch("/api/toggle",{
              method:"POST",
              headers:{"Content-Type":"application/json"},
              body:JSON.stringify({person:key,exercise:ex})
            });
            loadAndRender();
          });
        }

        cont.appendChild(row);
      });

      // Skip-Day: sichtbar, wenn ich selbst ODER wenn an diesem Tag geskippt wurde
      if (canClick || skippedToday){
        const skip = document.createElement("div");
        skip.className = "skip-btn" + (canClick ? "" : " readonly");
        skip.textContent = "Skip-Day nutzen";
        if (canClick){
          skip.addEventListener("click", async ()=>{
            const r = await fetch("/api/skip",{
              method:"POST",
              headers:{"Content-Type":"application/json"},
              body:JSON.stringify({person:key})
            });
            const data = await r.json();
            if (data.warning) alert(data.warning);
            loadAndRender();
          });
        }
        cont.appendChild(skip);
      }

      // Verletz / Krank: sichtbar bei eigener View oder wenn heute verletzt-markiert
      if (canClick || injuredToday){
        const inj = document.createElement("div");
        inj.className = "injured-btn" + (canClick ? "" : " readonly");
        inj.textContent = "Verletzt / krank (heute)";
        if (canClick){
          inj.addEventListener("click", async ()=>{
            const r = await fetch("/api/injured",{
              method:"POST",
              headers:{"Content-Type":"application/json"},
              body:JSON.stringify({person:key})
            });
            await r.json();
            loadAndRender();
          });
        }
        cont.appendChild(inj);
      }

      // Ich kann nicht mehr – sichtbar bei eigener View oder wenn heute genutzt
      if (canClick || cantToday){
        const cant = document.createElement("div");
        cant.className = "cant-btn" + (canClick ? "" : " readonly");
        cant.textContent = "Ich kann nicht mehr";
        if (canClick){
          cant.addEventListener("click", async (
