<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Daily Workout ‚Äì {{ male_name }} & {{ female_name }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- PWA / Icons -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest-' ~ role ~ '.json') }}">
    <link rel="icon" href="{{ url_for('static', filename='icons/icon-192.png') }}">

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #0f172a;
            color: #e5e7eb;
        }

        .app {
            max-width: 960px;
            margin: 0 auto;
            padding: 16px;
        }

        header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 16px;
        }

        .date-block {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .date-main {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .date-sub {
            font-size: 0.9rem;
            color: #9ca3af;
        }

        .role-block {
            text-align: right;
        }

        .role-label {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .role-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.85rem;
            background: rgba(148, 163, 184, 0.16);
            color: #e5e7eb;
        }

        .role-chip span.icon {
            font-size: 1.1rem;
        }

        .card {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 12px;
            padding: 12px 14px;
            margin-bottom: 12px;
            border: 1px solid rgba(55, 65, 81, 0.7);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 6px;
        }

        .card-title {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .card-sub {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        /* Totals-Grid: Mobile 1 Spalte, ab 640px 2 Spalten */
        .totals-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-top: 6px;
        }

        @media (min-width: 640px) {
            .totals-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        .totals-item {
            font-size: 0.85rem;
            color: #d1d5db;
            padding: 6px 8px;
            border-radius: 8px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(55, 65, 81, 0.7);
        }

        .totals-title {
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .totals-line {
            font-size: 0.85rem;
            margin-top: 2px;
        }

        .male-totals {
            border-left: 3px solid #60a5fa;
        }

        .male-totals .totals-title {
            color: #60a5fa;
        }

        .female-totals {
            border-left: 3px solid #f9a8d4;
        }

        .female-totals .totals-title {
            color: #f9a8d4;
        }

        .exercises {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
        }

        .exercise-card {
            background: rgba(15, 23, 42, 0.95);
            border-radius: 10px;
            padding: 10px;
            border: 1px solid rgba(55, 65, 81, 0.7);
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exercise-name {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .exercise-reps {
            font-size: 0.85rem;
            color: #9ca3af;
        }

        .exercise-action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 4px;
            padding: 6px 8px;
            font-size: 0.85rem;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            background: rgba(22, 163, 74, 0.12);
            color: #bbf7d0;
        }

        .exercise-action-btn.cant-ex {
            background: rgba(59, 130, 246, 0.18);
            color: #bfdbfe;
        }

        .exercise-action-btn.cant-ex.active {
            background: rgba(0,0,0,0.08);
            border-color: rgba(0,0,0,0.35);
        }

        .exercise-action-btn.done {
            background: rgba(22, 163, 74, 0.35);
            color: #ecfdf5;
        }

        .exercise-action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .exercise-action-btn span.icon {
            font-size: 1rem;
        }

        .exercise-other-status {
            font-size: 0.78rem;
            color: #9ca3af;
            margin-top: 2px;
        }

        .status-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .status-btn {
            flex: 1 1 120px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px;
            font-size: 0.85rem;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            white-space: nowrap;
            transition: filter 0.12s ease, box-shadow 0.12s ease;
        }

        .status-btn.skip {
            background: rgba(234, 179, 8, 0.12);
            color: #facc15;
        }

        .status-btn.injured {
            background: rgba(220, 38, 38, 0.16);
            color: #fecaca;
        }

        .status-btn.cant {
            background: rgba(59, 130, 246, 0.18);
            color: #bfdbfe;
        }

        /* NEU: Sport-Button */
        .status-btn.sport {
            background: rgba(16, 185, 129, 0.18);
            color: #a7f3d0;
        }

        .status-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .status-btn span.icon {
            font-size: 1.1rem;
        }

        /* aktive Status-Buttons etwas hervorheben */
        .status-btn.active {
            filter: brightness(1.25);
            box-shadow: 0 0 0 1px rgba(248, 250, 252, 0.35);
        }

        .status-summary {
            margin-top: 8px;
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .message-bar {
            margin-top: 10px;
            font-size: 0.85rem;
            padding: 8px 10px;
            border-radius: 8px;
        }

        .message-info {
            background: rgba(59, 130, 246, 0.12);
            border: 1px solid rgba(59, 130, 246, 0.4);
            color: #bfdbfe;
        }

        .message-error {
            background: rgba(220, 38, 38, 0.14);
            border: 1px solid rgba(239, 68, 68, 0.6);
            color: #fecaca;
        }

        .message-success {
            background: rgba(22, 163, 74, 0.12);
            border: 1px solid rgba(34, 197, 94, 0.5);
            color: #bbf7d0;
        }

        .phrase-card {
            font-size: 0.9rem;
            padding: 10px 12px;
            border-radius: 10px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px dashed rgba(148, 163, 184, 0.7);
            margin-top: 10px;
        }

        .phrase-label {
            font-size: 0.78rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: #9ca3af;
            margin-bottom: 4px;
        }

        .phrase-text {
            font-size: 0.95rem;
        }

        .badge {
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.7rem;
            background: rgba(148, 163, 184, 0.2);
            color: #e5e7eb;
        }

        .cheater-badge {
            background: rgba(248, 113, 113, 0.18);
            color: #fecaca;
        }

        .small { font-size: 0.8rem; }

        @media (max-width: 600px) {
            header { flex-direction: column; align-items: flex-start; }
            .role-block { text-align: left; }
        }
    </style>

    <script>
      window.__WC_NAMES__ = { male: "{{ male_name }}", female: "{{ female_name }}" };
      window.__wc_subst = function (txt) {
        if (typeof txt !== "string") return txt;
        return txt
          .replaceAll("{male}", window.__WC_NAMES__.male)
          .replaceAll("{female}", window.__WC_NAMES__.female);
      };
    </script>
</head>

<body data-role="{{ role }}" data-male-name="{{ male_name }}" data-female-name="{{ female_name }}">
<div class="app">

    <header>
        <div class="date-block">
            <div class="date-main">
                <span id="weekdayLabel">‚Äì</span>,
                <span id="dateLabel">‚Äì</span>
            </div>
            <div class="date-sub">
                Tag <span id="dayLabel">‚Äì</span> seit <span id="startDateLabel">‚Äì</span>
            </div>
        </div>
        <div class="role-block">
            <div class="role-label" id="roleTitle">‚Äì</div>
            <div class="role-chip">
                <span class="icon">üí™</span>
                <span id="roleDesc">‚Äì</span>
            </div>
        </div>
    </header>

    <!-- Totals -->
    <section class="card" id="totalsCard">
        <div class="card-header">
            <div class="card-title">
                Gesamt-√úbersicht <span class="small">seit <span id="totalsStartLabel">‚Äì</span></span>
            </div>
        </div>
        <div class="totals-grid">
            <div class="totals-item male-totals">
                <div class="totals-title"><strong>Total {{ male_name }}</strong></div>
                <div class="totals-line"><span id="totalsMaleCrunches">‚Äì</span> Crunches</div>
                <div class="totals-line"><span id="totalsMaleSquats">‚Äì</span> Squats</div>
                <div class="totals-line"><span id="totalsMalePushups">‚Äì</span> Pushups</div>
            </div>

            <div class="totals-item female-totals">
                <div class="totals-title"><strong>Total {{ female_name }}</strong></div>
                <div class="totals-line"><span id="totalsFemaleCrunches">‚Äì</span> Crunches</div>
                <div class="totals-line"><span id="totalsFemaleSquats">‚Äì</span> Squats</div>
                <div class="totals-line"><span id="totalsFemalePushups">‚Äì</span> Pushups</div>
            </div>

            <div class="totals-item male-totals">
                <div class="totals-title"><strong>Spezialtage {{ male_name }}</strong></div>
                <div class="totals-line"><span id="totalsMaleSkip">‚Äì</span> Skips</div>
                <div class="totals-line"><span id="totalsMaleInjured">‚Äì</span> krank/verletzt</div>
                <div class="totals-line"><span id="totalsMaleCant">‚Äì</span> Ich kann nicht mehr!</div>
                <div class="totals-line"><span id="totalsMaleSport">‚Äì</span> Sporttage</div>
            </div>

            <div class="totals-item female-totals">
                <div class="totals-title"><strong>Spezialtage {{ female_name }}</strong></div>
                <div class="totals-line"><span id="totalsFemaleSkip">‚Äì</span> Skips</div>
                <div class="totals-line"><span id="totalsFemaleInjured">‚Äì</span> krank/verletzt</div>
                <div class="totals-line"><span id="totalsFemaleCant">‚Äì</span> Ich kann nicht mehr!</div>
                <div class="totals-line"><span id="totalsFemaleSport">‚Äì</span> Sporttage</div>
            </div>
        </div>
    </section>

    <!-- Exercises & actions -->
    <section class="card">
        <div class="card-header">
            <div class="card-title">
                Heutige Einheit <span class="small">(f√ºr <span id="currentNameLabel">‚Äì</span>)</span>
            </div>
            <div class="card-sub" id="repsSummary">‚Äì</div>
        </div>

        <div class="exercises">
            <div class="exercise-card" id="card-crunches">
                <div class="exercise-header">
                    <div class="exercise-name">Crunches</div>
                    <div class="exercise-reps"><span id="reps-crunches">‚Äì</span> Wiederholungen</div>
                </div>
                <button class="exercise-action-btn" id="btn-crunches" type="button">
                    <span class="icon">‚úÖ</span>
                    <span class="label">erledigt</span>
                </button>
                <button class="exercise-action-btn cant-ex" id="btn-cant-crunches" type="button">
                  <span class="icon">ü§¨</span>
                  <span class="label">Ich kann nicht mehr (‚àí10)</span>
                </button>
<div class="exercise-other-status" id="other-crunches-status"></div>
            </div>

            <div class="exercise-card" id="card-pushups">
                <div class="exercise-header">
                    <div class="exercise-name">Pushups</div>
                    <div class="exercise-reps"><span id="reps-pushups">‚Äì</span> Wiederholungen</div>
                </div>
                <button class="exercise-action-btn" id="btn-pushups" type="button">
                    <span class="icon">‚úÖ</span>
                    <span class="label">erledigt</span>
                </button>
                <button class="exercise-action-btn cant-ex" id="btn-cant-pushups" type="button">
                  <span class="icon">ü§¨</span>
                  <span class="label">Ich kann nicht mehr (‚àí10)</span>
                </button>
<div class="exercise-other-status" id="other-pushups-status"></div>
            </div>

            <div class="exercise-card" id="card-squats">
                <div class="exercise-header">
                    <div class="exercise-name">Squats</div>
                    <div class="exercise-reps"><span id="reps-squats">‚Äì</span> Wiederholungen</div>
                </div>
                <button class="exercise-action-btn" id="btn-squats" type="button">
                    <span class="icon">‚úÖ</span>
                    <span class="label">erledigt</span>
                </button>
                <button class="exercise-action-btn cant-ex" id="btn-cant-squats" type="button">
                  <span class="icon">ü§¨</span>
                  <span class="label">Ich kann nicht mehr (‚àí10)</span>
                </button>
<div class="exercise-other-status" id="other-squats-status"></div>
            </div>
        </div>

        <div class="status-row">
            <!-- NEU: Sport -->
            <button class="status-btn sport" id="btn-sport" type="button">
                <span class="icon">üèÖ</span>
                <span>heute Sport gemacht</span>
            </button>

            <button class="status-btn injured" id="btn-injured" type="button">
                <span class="icon">‚ùå</span>
                <span>krank / verletzt</span>
            </button>
            <button class="status-btn skip" id="btn-skip" type="button">
                <span class="icon">üò¥</span>
                <span>Skip</span>
            </button>
        </div>

        <div id="statusSummary" class="status-summary"></div>
        <div id="messageBox" class="message-bar" style="display:none;"></div>
    </section>

    <!-- Phrase -->
    <section class="phrase-card">
        <div class="phrase-label">
            <span id="phraseCategoryBadge" class="badge">‚Äì</span>
        </div>
        <div class="phrase-text" id="phraseText">‚Ä¶</div>
    </section>

    <!-- Next day -->
    <section class="card">
        <div class="card-header">
            <div class="card-title">Tag abschlie√üen</div>
        </div>
        <button class="status-btn cant" id="btn-nextday" type="button">
            <span class="icon">‚è≠</span>
            <span>N√§chster Tag</span>
        </button>
        <div class="status-summary small">
            Nur klicken, wenn ihr beide f√ºr heute durch seid.
        </div>
    </section>

</div>

<script>
(function () {
    var role = document.body.getAttribute('data-role');
    var maleName = document.body.getAttribute('data-male-name');
    var femaleName = document.body.getAttribute('data-female-name');

    var stateData = null;
    var phrasesCache = {};

    function xhrGet(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                if (xhr.status >= 200 && xhr.status < 300) {
                    try { callback(null, JSON.parse(xhr.responseText)); }
                    catch (e) { callback(e); }
                } else {
                    callback(new Error('HTTP ' + xhr.status));
                }
            }
        };
        xhr.send();
    }

    function xhrPost(url, body, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', url, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                if (xhr.status >= 200 && xhr.status < 300) {
                    try { callback(null, JSON.parse(xhr.responseText)); }
                    catch (e) { callback(e); }
                } else {
                    callback(new Error('HTTP ' + xhr.status));
                }
            }
        };
        xhr.send(JSON.stringify(body));
    }

    function hardLock(text){ showMessage(text || 'Aktion nicht erlaubt.', 'error'); }

      function showMessage(text, type) {
        var box = document.getElementById('messageBox');
        if (!text) {
            box.style.display = 'none';
            box.className = 'message-bar';
            box.innerHTML = '';
            return;
        }
        var cls = 'message-bar ';
        if (type === 'error') cls += 'message-error';
        else if (type === 'success') cls += 'message-success';
        else cls += 'message-info';

        box.className = cls;
        box.textContent = __wc_subst(text);
        box.style.display = 'block';
    }

    function pickDeterministic(arr, day, salt) {
        if (!arr || !arr.length) return "";
        var idx = ((day - 1) + salt) % arr.length;
        return arr[idx];
    }

    function getPhraseCategoryLabel(cat) {
        if (cat === 'none_done') return 'Keiner fertig';
        if (cat === 'all_done') return 'Beide fertig';
        if (cat.indexOf('one_done_') === 0) return 'Nur einer fertig';
        if (cat.indexOf('skip_') === 0) return 'Skip-Tag';
        if (cat.indexOf('cant_') === 0) return 'Ich kann nicht mehr!';
        if (cat.indexOf('injured_') === 0) return 'krank / verletzt';
        if (cat.indexOf('cheater_') === 0) return 'Cheater-Alarm';
        return cat || 'Unbekannt';
    }

    function loadPhraseCategory(category, cb) {
        if (phrasesCache.hasOwnProperty(category)) { cb(null, phrasesCache[category]); return; }
        var url = '/static/phrases/' + encodeURIComponent(category) + '.json?v=' + Date.now();
        xhrGet(url, function (err, data) {
            var textEl = document.getElementById('phraseText');
            if (err) {
                textEl.textContent = __wc_subst("Fehler beim Laden der Spr√ºche: " + err.message);
                cb(err);
                return;
            }
            phrasesCache[category] = data;
            cb(null, data);
        });
    }

    function updatePhrase() {
        if (!stateData || !stateData.phrase_category) return;
        var day = stateData.day || 1;
        var category = stateData.phrase_category;

        loadPhraseCategory(category, function (err, phrasesArray) {
            var labelEl = document.getElementById('phraseCategoryBadge');
            var textEl = document.getElementById('phraseText');

            labelEl.textContent = __wc_subst(getPhraseCategoryLabel(category));
            labelEl.className = (category.indexOf('cheater_') === 0) ? 'badge cheater-badge' : 'badge';

            if (err) return;

            var salt = 0;
            if (category.indexOf('one_done_') === 0) salt = 1;
            else if (category === 'all_done') salt = 2;
            else if (category.indexOf('skip_') === 0) salt = 3;
            else if (category.indexOf('cant_') === 0) salt = 4;
            else if (category.indexOf('injured_') === 0) salt = 5;
            else if (category.indexOf('cheater_') === 0) salt = 6;

            var phrase = pickDeterministic(phrasesArray, day, salt);
            textEl.textContent = __wc_subst(phrase || '‚Ä¶');
        });
    }

    function buildHumanStatus(s) {
        if (!s) return 'noch nichts gemacht';
        if (s.injured) return 'krank/verletzt';
        if (s.cant) return 'Ich kann nicht mehr!';
        if (s.skip) return 'Skip';
        if (s.sport) return 'Sport gemacht';
        var doneCount = 0;
        if (s.crunches_done) doneCount++;
        if (s.pushups_done) doneCount++;
        if (s.squats_done) doneCount++;
        if (doneCount === 0) return 'noch nichts gemacht';
        if (doneCount === 3) return 'alle √úbungen erledigt';
        return 'teilweise erledigt';
    }

    function updateUI() {
        if (!stateData) return;

        document.getElementById('weekdayLabel').textContent = __wc_subst(stateData.weekday || '‚Äì');
        document.getElementById('dateLabel').textContent = __wc_subst(stateData.date || '‚Äì');
        document.getElementById('dayLabel').textContent = __wc_subst(stateData.day || '‚Äì');

        var startDisplay = stateData.start_date_display || stateData.start_date || '‚Äì';
        document.getElementById('startDateLabel').textContent = __wc_subst(startDisplay);
        document.getElementById('totalsStartLabel').textContent = __wc_subst(startDisplay);

        var otherRole = (role === 'mann') ? 'frau' : 'mann';
        var myName = (role === 'mann') ? maleName : femaleName;
        var otherName = (role === 'mann') ? femaleName : maleName;

        if (role === 'mann') {
            document.getElementById('roleTitle').textContent = __wc_subst(maleName + " ‚Äì deine Seite");
            document.getElementById('roleDesc').textContent = __wc_subst("Nur du kannst hier abhaken.");
            document.getElementById('currentNameLabel').textContent = __wc_subst(maleName);
        } else {
            document.getElementById('roleTitle').textContent = __wc_subst(femaleName + " ‚Äì deine Seite");
            document.getElementById('roleDesc').textContent = __wc_subst("Nur du kannst hier abhaken.");
            document.getElementById('currentNameLabel').textContent = __wc_subst(femaleName);
        }

        var totals = stateData.totals || {};
        var tM = totals.mann || {};
        var tF = totals.frau || {};

        document.getElementById('totalsMaleCrunches').textContent = __wc_subst(tM.crunches || 0);
        document.getElementById('totalsMaleSquats').textContent   = __wc_subst(tM.squats || 0);
        document.getElementById('totalsMalePushups').textContent  = __wc_subst(tM.pushups || 0);

        document.getElementById('totalsFemaleCrunches').textContent = __wc_subst(tF.crunches || 0);
        document.getElementById('totalsFemaleSquats').textContent   = __wc_subst(tF.squats || 0);
        document.getElementById('totalsFemalePushups').textContent  = __wc_subst(tF.pushups || 0);

        document.getElementById('totalsMaleSkip').textContent    = __wc_subst(tM.skip_days || 0);
        document.getElementById('totalsMaleCant').textContent    = __wc_subst(tM.cant_days || 0);
        document.getElementById('totalsMaleInjured').textContent = __wc_subst(tM.injured_days || 0);
        document.getElementById('totalsMaleSport').textContent   = __wc_subst(tM.sport_days || 0);

        document.getElementById('totalsFemaleSkip').textContent    = __wc_subst(tF.skip_days || 0);
        document.getElementById('totalsFemaleCant').textContent    = __wc_subst(tF.cant_days || 0);
        document.getElementById('totalsFemaleInjured').textContent = __wc_subst(tF.injured_days || 0);
        document.getElementById('totalsFemaleSport').textContent   = __wc_subst(tF.sport_days || 0);

        var repsToday = stateData.reps_today || {};
        var myReps = repsToday[role] || {};
        var rCrunch = myReps.crunches || 0;
        var rPush   = myReps.pushups || 0;
        var rSquat  = myReps.squats || 0;

        document.getElementById('reps-crunches').textContent = __wc_subst(rCrunch);
        document.getElementById('reps-pushups').textContent  = __wc_subst(rPush);
        document.getElementById('reps-squats').textContent   = __wc_subst(rSquat);

        document.getElementById('repsSummary').textContent =
            __wc_subst(rCrunch + " Crunches ‚Ä¢ " + rPush + " Pushups ‚Ä¢ " + rSquat + " Squats");

        var statusAll = stateData.status || {};
        var myStatus = statusAll[role] || {};
        var otherStatus = statusAll[otherRole] || {};

        function updateExerciseButton(id, done) {
            var btn = document.getElementById('btn-' + id);
            if (!btn) return;
            if (done) {
                btn.className = "exercise-action-btn done";
                btn.querySelector('.label').textContent = __wc_subst("erledigt ‚úî");
            } else {
                btn.className = "exercise-action-btn";
                btn.querySelector('.label').textContent = __wc_subst("erledigt");
            }
        }

        updateExerciseButton('crunches', !!myStatus.crunches_done);
        updateExerciseButton('pushups', !!myStatus.pushups_done);
        updateExerciseButton('squats',  !!myStatus.squats_done);

        function updateCantExButton(exId, active) {
            var btn = document.getElementById('btn-cant-' + exId);
            if (!btn) return;
            btn.classList.toggle('active', !!active);
        }

        updateCantExButton('crunches', !!myStatus.cant_crunches);
        updateCantExButton('pushups',  !!myStatus.cant_pushups);
        updateCantExButton('squats',   !!myStatus.cant_squats);

        var otherCrunchEl = document.getElementById('other-crunches-status');
        var otherPushEl   = document.getElementById('other-pushups-status');
        var otherSquatEl  = document.getElementById('other-squats-status');

        if (otherCrunchEl) otherCrunchEl.textContent = __wc_subst(otherName + (otherStatus.crunches_done ? " ‚úÖ" : " ‚ùå"));
        if (otherPushEl)   otherPushEl.textContent   = __wc_subst(otherName + (otherStatus.pushups_done ? " ‚úÖ" : " ‚ùå"));
        if (otherSquatEl)  otherSquatEl.textContent  = __wc_subst(otherName + (otherStatus.squats_done ? " ‚úÖ" : " ‚ùå"));

        var btnSkip  = document.getElementById('btn-skip');
        var btnInj   = document.getElementById('btn-injured');
        var btnSport = document.getElementById('btn-sport');

        var canSkipAll  = stateData.can_skip  || {};
        var canCantExAll = stateData.can_cant_ex || {};

        var canCantAll  = stateData.can_cant  || {};
        var canSportAll = stateData.can_sport || {};

        var canSkip  = (typeof canSkipAll[role]  === 'boolean') ? canSkipAll[role]  : true;
        var canCant  = (typeof canCantAll[role]  === 'boolean') ? canCantAll[role]  : true;
        var canSport = (typeof canSportAll[role] === 'boolean') ? canSportAll[role] : true;

        var canCantEx = canCantExAll[role] || {};


        var sportActive = !!myStatus.sport;

        // Sport togglebar; wenn Sport aktiv -> alles andere sperren
        if (btnSport) {
            btnSport.disabled = !canSport && !sportActive;
            btnSport.classList.toggle('active', sportActive);
        }

        if (btnSkip) {
            btnSkip.disabled = sportActive || (!canSkip && !myStatus.skip);
            btnSkip.classList.toggle('active', !!myStatus.skip);
        }
if (btnInj) {
            btnInj.disabled = sportActive;
            btnInj.classList.toggle('active', !!myStatus.injured);
        }

        // √úbungsbuttons sperren wenn Sport aktiv
        ['crunches','pushups','squats'].forEach(function(ex){
            var b = document.getElementById('btn-' + ex);
            if (b) b.disabled = sportActive;
        });

        // per-exercise cant buttons: active + cooldown gating
        ['crunches','pushups','squats'].forEach(function(exKey) {
            var b = document.getElementById('btn-cant-' + exKey);
            if (!b) return;

            var active = !!myStatus['cant_' + exKey];
            var canMap = (stateData && stateData.can_cant_ex && stateData.can_cant_ex[role]) ? stateData.can_cant_ex[role] : null;
            var canUse = (canMap && typeof canMap[exKey] === 'boolean') ? canMap[exKey] : true;

            b.disabled = sportActive || (!canUse && !active);
            b.classList.toggle('active', active);
        });

var statusSummary = document.getElementById('statusSummary');
        if (statusSummary) {
            var myHuman = buildHumanStatus(myStatus);
            var otherHuman = buildHumanStatus(otherStatus);
            statusSummary.textContent = __wc_subst("Du: " + myHuman + " ‚Ä¢ " + otherName + ": " + otherHuman);
        }
        if (stateData.message) showMessage(stateData.message, "info");
        else showMessage("", "");
updatePhrase();
    }

    function loadState() {
        xhrGet('/api/state?role=' + encodeURIComponent(role), function (err, data) {
            if (err) { showMessage("Fehler beim Laden des Status: " + err.message, "error"); return; }
            stateData = data;
            updateUI();
        });
    }

    function sendAction(type, extra) {
        var body = { role: role, action: type };
        if (extra) for (var k in extra) if (extra.hasOwnProperty(k)) body[k] = extra[k];

        xhrPost('/api/action', body, function (err, data) {
            if (err) { showMessage("Aktion fehlgeschlagen: " + err.message, "error"); return; }
            stateData = data;
            updateUI();
        });
    }

    function getMyStatus() {
        if (!stateData || !stateData.status) return {};
        return stateData.status[role] || {};
    }

    function bindEvents() {
        var btnCrunch = document.getElementById('btn-crunches');
        var btnPush  = document.getElementById('btn-pushups');
        var btnSquat = document.getElementById('btn-squats');


        var btnCantCrunch = document.getElementById('btn-cant-crunches');
        var btnCantPush   = document.getElementById('btn-cant-pushups');
        var btnCantSquat  = document.getElementById('btn-cant-squats');
        var btnSkip  = document.getElementById('btn-skip');
        var btnInj   = document.getElementById('btn-injured');
        var btnSport = document.getElementById('btn-sport');

        var btnNext  = document.getElementById('btn-nextday');

        if (btnCrunch) btnCrunch.onclick = function () {
            var s = getMyStatus();
            var isDone = !!s.crunches_done;
            sendAction(isDone ? 'exercise_undo' : 'exercise', { exercise: 'crunches' });
        };

        if (btnPush) btnPush.onclick = function () {
            var s = getMyStatus();
            var isDone = !!s.pushups_done;
            sendAction(isDone ? 'exercise_undo' : 'exercise', { exercise: 'pushups' });
        };

        if (btnSquat) btnSquat.onclick = function () {
            var s = getMyStatus();
            var isDone = !!s.squats_done;
            sendAction(isDone ? 'exercise_undo' : 'exercise', { exercise: 'squats' });
        };

        

        // Per-exercise cant (toggle, password on enable)
        function bindCantEx(btn, exKey, statusKey) {
            if (!btn) return;

            btn.addEventListener('click', function () {
                // if already active -> undo (always allowed)
                var isActive = btn.classList.contains('active');
                var action = isActive ? 'cant_exercise_undo' : 'cant_exercise';

                // if trying to set and server says cooldown false, block client-side
                if (!isActive) {
                    var canMap = (stateData && stateData.can_cant_ex && stateData.can_cant_ex[role]) || null;
                    if (canMap && canMap[exKey] === false) {
                        // soft block; server will also enforce
                        return;
                    }
                }

                sendAction(action, { exercise: exKey });
            });
        }

        bindCantEx(btnCantCrunch, 'crunches', 'cant_crunches');
        bindCantEx(btnCantPush,   'pushups',  'cant_pushups');
        bindCantEx(btnCantSquat,  'squats',   'cant_squats');
if (btnSkip) btnSkip.onclick = function () {
            var s = getMyStatus();
            sendAction(s.skip ? 'skip_undo' : 'skip', {});
        };

        if (btnInj) btnInj.onclick = function () {
            var s = getMyStatus();
            sendAction(s.injured ? 'injured_undo' : 'injured', {});
        };

// NEU: Sport toggle
        if (btnSport) btnSport.onclick = function () {
            var s = getMyStatus();
            sendAction(s.sport ? 'sport_undo' : 'sport', {});
        };

        if (btnNext) btnNext.onclick = function () {
            if (!window.confirm("Sicher? N√§chster Tag kann nicht r√ºckg√§ngig gemacht werden.")) return;
            xhrPost('/api/nextday', {}, function (err, data) {
                if (err) { showMessage("Konnte n√§chsten Tag nicht starten: " + err.message, "error"); return; }
                stateData = data;
                updateUI();
                showMessage("Neuer Tag gestartet.", "success");
            });
        };
    }

    window.hardLock = hardLock;

      document.addEventListener('DOMContentLoaded', function () {
        bindEvents();
        loadState();
    });
})();
</script>

</body>
</html>
